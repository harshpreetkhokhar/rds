name: Check RDS Restore Time

on:
  workflow_dispatch:  # Manual trigger
  
  # schedule:
  #   - cron: "* * * * *" 
jobs:
  check-restore-time:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: us-east-1

      - name: Get Current Restore Time from AWS
        id: get-restore-time
        run: |
          set -e  # Stop script on first error
          
          INSTANCE_ID="database-1"
          LAST_RESTORE_TIME=$(aws rds describe-db-instances --db-instance-identifier "$INSTANCE_ID" --query "DBInstances[0].LatestRestorableTime" --output text)
          
          if [ -z "$LAST_RESTORE_TIME" ] || [ "$LAST_RESTORE_TIME" == "None" ]; then
            echo "Error: Could not retrieve RDS Restore Time!"
            exit 1
          fi
          
          echo "LAST_RESTORE_TIME=$LAST_RESTORE_TIME" >> $GITHUB_ENV
          echo "Retrieved Restore Time: $LAST_RESTORE_TIME"

      - name: Compare with Last Stored Restore Time
        id: compare-time
        run: |
          set -e  # Stop script on first error

          # Read previous restore time from file (or default to "none")
          if [ -f restore_time.txt ]; then
            STORED_RESTORE_TIME=$(cat restore_time.txt)
          else
            STORED_RESTORE_TIME="none"
          fi
          
          echo "Stored Restore Time: $STORED_RESTORE_TIME"
          echo "Current Restore Time: $LAST_RESTORE_TIME"

          if [[ "$LAST_RESTORE_TIME" != "$STORED_RESTORE_TIME" ]]; then
            echo "Restore time changed, triggering pipeline 2"
            echo "$LAST_RESTORE_TIME" > restore_time.txt
            echo "trigger=true" >> $GITHUB_ENV
          else
            echo "Restore time unchanged, no action needed."
            echo "trigger=false" >> $GITHUB_ENV
          fi

      - name: Commit Updated Restore Time
        if: env.trigger == 'true'
        run: |
          set -e  # Stop script on first error
          
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          git add restore_time.txt
          git commit -m "Updated RDS Restore Time to $LAST_RESTORE_TIME"
           git push https://x-access-token:${{ secrets.GH_PAT }}@github.com/harshpreetkhokhar/rds.git main

      - name: Trigger Pipeline 2
        if: env.trigger == 'true'
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: stop_rds.yml
          token: ${{ secrets.GH_PAT }}
